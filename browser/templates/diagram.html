{% extends "base.html" %}
{% block title %}{{ diagram.diagram_name }} - DrawIO Browser{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="/">Home</a>
    <span>/</span>
    <a href="/space/{{ diagram.space_key }}">{{ diagram.space_key }}</a>
    <span>/</span>
    <strong>{{ diagram.diagram_name }}</strong>
</div>

<div class="diagram-detail">
    <div class="diagram-image-container">
        <!-- Carousel navigation arrows -->
        {% if prev_id %}
        <a href="/diagram/{{ prev_id }}" class="carousel-nav carousel-prev" title="Previous diagram (Left arrow)">
            <span class="carousel-arrow">&larr;</span>
        </a>
        {% endif %}
        {% if next_id %}
        <a href="/diagram/{{ next_id }}" class="carousel-nav carousel-next" title="Next diagram (Right arrow)">
            <span class="carousel-arrow">&rarr;</span>
        </a>
        {% endif %}

        <img src="/image/{{ diagram.space_key }}/{{ diagram.diagram_name }}.png"
             alt="{{ diagram.diagram_name }}"
             onerror="this.parentElement.innerHTML='<p style=\'color:#999;padding:50px;\'>Preview not available</p>'">

        <!-- Position indicator -->
        {% if total_in_space > 1 %}
        <div class="carousel-position">{{ position }} of {{ total_in_space }}</div>
        {% endif %}
    </div>
    <div class="diagram-info">
        <h1>{{ diagram.diagram_name }}</h1>

        <div class="action-buttons">
            {% if confluence_url and diagram.confluence_page_url %}
            <a href="{{ confluence_url }}{{ diagram.confluence_page_url }}"
               target="_blank"
               class="action-btn action-btn-confluence">
                View in Confluence
            </a>
            {% endif %}
            {% if show_edit_buttons %}
            <a href="/download/{{ diagram.space_key }}/{{ diagram.diagram_name }}.drawio"
               class="action-btn action-btn-primary">
                Download .drawio
            </a>
            <button onclick="editLocal('{{ diagram.space_key }}', '{{ diagram.diagram_name }}')"
                    class="action-btn action-btn-outline">
                Edit Local
            </button>
            <button onclick="editWeb('{{ diagram.space_key }}', '{{ diagram.diagram_name }}')"
                    class="action-btn action-btn-secondary">
                Edit in Browser
            </button>
            {% endif %}
        </div>

        <div class="info-grid">
            <div class="info-item">
                <label>Space</label>
                <value><a href="/space/{{ diagram.space_key }}">{{ diagram.space_key }}</a></value>
            </div>
            {% if diagram.page_title %}
            <div class="info-item">
                <label>Confluence Page</label>
                <value>{{ diagram.page_title }}</value>
            </div>
            {% endif %}
            {% if diagram.page_id %}
            <div class="info-item">
                <label>Page ID</label>
                <value>{{ diagram.page_id }}</value>
            </div>
            {% endif %}
            {% if diagram.author_display %}
            <div class="info-item">
                <label>Author</label>
                <value>{{ diagram.author_display }}</value>
            </div>
            {% endif %}
            {% if diagram.created_date %}
            <div class="info-item">
                <label>Created</label>
                <value>{{ diagram.created_date }}</value>
            </div>
            {% endif %}
            {% if diagram.file_size %}
            <div class="info-item">
                <label>File Size</label>
                <value>{{ (diagram.file_size / 1024)|round(1) }} KB</value>
            </div>
            {% endif %}
        </div>

        {% if diagram.content_text %}
        <div style="margin-top: 30px;">
            <label style="display:block;font-size:0.85em;color:#7f8c8d;margin-bottom:8px;">Extracted Text Content</label>
            <div style="background:#f8f9fa;padding:15px;border-radius:6px;font-size:0.9em;max-height:200px;overflow:auto;">
                {{ diagram.content_text[:1000] }}{% if diagram.content_text|length > 1000 %}...{% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Keyboard navigation for carousel
document.addEventListener('keydown', function(e) {
    // Don't trigger if user is typing in an input field
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

    if (e.key === 'ArrowLeft' || e.key === 'Left') {
        {% if prev_id %}
        window.location.href = '/diagram/{{ prev_id }}';
        {% endif %}
    } else if (e.key === 'ArrowRight' || e.key === 'Right') {
        {% if next_id %}
        window.location.href = '/diagram/{{ next_id }}';
        {% endif %}
    }
});

function editLocal(spaceKey, diagramName) {
    // Download the .drawio file for local editing
    // User can then open it with draw.io Desktop application
    window.location.href = '/download/' + spaceKey + '/' + encodeURIComponent(diagramName) + '.drawio';

    // Show helpful message
    setTimeout(function() {
        alert('File downloaded. Open it with draw.io Desktop to edit.\n\n' +
              'Download draw.io Desktop from: https://github.com/jgraph/drawio-desktop/releases');
    }, 500);
}

function editWeb(spaceKey, diagramName) {
    // Open diagram directly in app.diagrams.net (draw.io web editor)
    // Server provides CORS headers so draw.io can fetch the file

    var fileUrl = window.location.origin + '/download/' + spaceKey + '/' +
                  encodeURIComponent(diagramName) + '.drawio';

    // draw.io URL parameters:
    // - url: diagram file URL (requires CORS headers on server)
    // - splash=0: skip splash screen
    // - title: set document title
    var editorUrl = 'https://app.diagrams.net/?splash=0&title=' +
                    encodeURIComponent(diagramName) +
                    '&url=' + encodeURIComponent(fileUrl);

    // Open directly - diagram loads automatically
    window.open(editorUrl, '_blank');
}
</script>
{% endblock %}
